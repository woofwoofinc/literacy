<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Literacy &#8212; Literacy</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/woofwoofinc.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Parser" href="parser.js.html" />
    <link rel="prev" title="Source Code" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Literacy</a>
        <span class="navbar-text navbar-version pull-left"><b>1.1.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Contents <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Literacy</a></li>
<li class="toctree-l1"><a class="reference internal" href="parser.js.html">Parser</a><ul>
<li class="toctree-l2"><a class="reference internal" href="parser.js.html#exports">Exports</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.js.html">Command Line Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="cli.js.html#option-handling">Option Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.js.html#validation">Validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.js.html#compile-single-file">Compile Single File</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.js.html#compile-directory">Compile Directory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="register.js.html">Register <code class="docutils literal"><span class="pre">.js.rst</span></code> File Extension</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.js.html">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="utils.js.html#recursive-directory-enumeration">Recursive Directory Enumeration</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.js.html#glob-expansion">Glob Expansion</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../loader/literacy-loader.js.html">Webpack Loader</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev.html">Development Tools Container</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../dev.html#building">Building</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../building.html">Building</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasing.html">Releasing</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../releasing.html#publishing-to-npm">Publishing to NPM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releasing.html#publishing-webpack-loader-to-npm">Publishing Webpack Loader to NPM</a></li>
<li class="toctree-l2"><a class="reference internal" href="../releasing.html#publishing-the-documentation">Publishing the Documentation</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conduct.html">Contributor Covenant Code of Conduct</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#our-pledge">Our Pledge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#our-standards">Our Standards</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#our-responsibilities">Our Responsibilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#scope">Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#enforcement">Enforcement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conduct.html#attribution">Attribution</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../thanks.html">Thanks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../index.html" title="Previous Chapter: Source Code"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Source Code</span>
    </a>
  </li>
  <li>
    <a href="parser.js.html" title="Next Chapter: Parser"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Parser &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="literacy">
<h1>Literacy<a class="headerlink" href="#literacy" title="Permalink to this headline">¶</a></h1>
<p>Literate programming in JavaScript using reStructuredText.</p>
<p>Support converting string content from reStructuredText format to JavaScript.
This parses the parameter file contents as a <code class="docutils literal"><span class="pre">.js.rst</span></code> or <code class="docutils literal"><span class="pre">.json.rst</span></code> file
and returns the code blocks concatenated together with a sourcemap.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">parser</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./parser&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">sourcemap</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;source-map&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">fromFileContents</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fromFileContents</span><span class="p">(</span><span class="nx">inputFilename</span><span class="p">,</span> <span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<p>Start a <a class="reference external" href="https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/">source map</a> for the output. The Literacy reStructured Text file format
is impractical without access to debugger tools or stacktrace line number
translation so source maps are essential.</p>
<p>Uses the <a class="reference external" href="https://github.com/mozilla/source-map">Mozilla source map module</a> to generate line based source maps.
Accurate correspondence is sufficiently granular at line-level. Calculating line
and column correspondence is complicated since the input file is detabbed for
convenience during parsing.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">sourceMapGenerator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">sourcemap</span><span class="p">.</span><span class="nx">SourceMapGenerator</span><span class="p">({</span>
  <span class="nx">file</span><span class="o">:</span> <span class="nx">inputFilename</span><span class="p">,</span>
<span class="p">});</span>

<span class="nx">sourceMapGenerator</span><span class="p">.</span><span class="nx">setSourceContent</span><span class="p">(</span><span class="nx">inputFilename</span><span class="p">,</span> <span class="nx">input</span><span class="p">);</span>
</pre></div>
</div>
<p>Now, parse the input file contents and use the parser output blocks to select
the lines which should be interpreted as code and collect these for output.</p>
<p>This will require some tracking state.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">parsed</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">(</span><span class="nx">input</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">output</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">outputLineNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">indent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">inCode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</pre></div>
</div>
<p>Any non-blank lines with text should be considered code if they follow one of
the marker directive start lines and have an indentation level which is greater
than the directive start line. The first line with an indentation level the same
as or less than the marker directive line terminates the line inclusions for
that directive line.</p>
<p>Scan the line classification blocks in turn.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">parsed</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">line</span> <span class="p">=&gt;</span> <span class="p">{</span>
</pre></div>
</div>
<p>Do the directive end condition first. We need to be already in a code block and
the current line must have an indentation level less than or equal to the
directive line.</p>
<p>Note that blank lines are not given an <code class="docutils literal"><span class="pre">indent</span></code> indentation level in the
parser. This means they are ignored for the purposes of concluding a code
directive block.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">inCode</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indent</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indent</span> <span class="o">&lt;=</span> <span class="nx">indent</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">inCode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">indent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the current line classification is for a marker directive line, set tracking
state to indicate we are currently in a code block.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">inCode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">indent</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">indent</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If we are currently in a code block and the line has text then include that into
the output. Note that the directive lines themselves are not given a <code class="docutils literal"><span class="pre">text</span></code>
property in the parser so they don’t contribute to the output here. Blank lines
have text consisting of an empty line so they are included in the generated
output.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">inCode</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">line</span><span class="p">.</span><span class="nx">text</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">outputLineNumber</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
</pre></div>
</div>
<p>For each output line, add an entry in the source map generator with the
corresponding input line.</p>
<p>Source map line numbers are required to be one-indexed. The PEG.js line numbers
are already one-indexed and we have maintained the output line number counter
one-indexed also by design.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>    <span class="nx">sourceMapGenerator</span><span class="p">.</span><span class="nx">addMapping</span><span class="p">({</span>
      <span class="nx">source</span><span class="o">:</span> <span class="nx">inputFilename</span><span class="p">,</span>
      <span class="nx">original</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">line</span><span class="o">:</span> <span class="nx">line</span><span class="p">.</span><span class="nx">lineNumber</span><span class="p">,</span>
        <span class="nx">column</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="nx">generated</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">line</span><span class="o">:</span> <span class="nx">outputLineNumber</span><span class="p">,</span>
        <span class="nx">column</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Create the output, ensuring it ends on a newline.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span>  <span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>

  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">content</span><span class="o">:</span> <span class="nx">output</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">),</span>
    <span class="nx">sourceMap</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">sourceMapGenerator</span><span class="p">.</span><span class="nx">toString</span><span class="p">()),</span>
  <span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Include a wrapper for processing a <code class="docutils literal"><span class="pre">.js.rst</span></code> file directly.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">fromFile</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fromFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filename</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
  <span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">fromFileContents</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
    </p>
  </div>
</footer>
  </body>
</html>